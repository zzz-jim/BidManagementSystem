@model IEnumerable<ScientificResearch.ViewModel.ERPNWorkToDoViewModel>

@using ScientificResearch.Utility.Enums;

<br />

<div id="fundssearchdata">
    <input type="hidden" name="projectName" id="projectName" style="width: 150px; height: 30px">&nbsp;

    <input type="hidden" id="Freeze" name="Freeze" value="全部" class="k-list-container k-popup k-group k-reset">
    <label for="start">开始时间:</label>
    <input id="startTime" name="startTime" value="" style="width: 150px " />&nbsp;
    <label for="end">结束时间</label>
    <input id="endTime" name="endTime" value="" style="width: 150px" />&nbsp;

    状态：
    <select id="State" name="State" style="width:150px; height:23px" class="k-list-container k-popup k-group k-reset">
        &nbsp;
        <option value=全部 selected="selected">全部</option>
        <option value=CostRegistSubmit>费用已登记</option>
        <option value=BookCostRegistNot>书本使用费未登记</option>
        <option value=BookCostRegistSubmit>书本使用费已登记</option>
        <option value=GraduationCertificateNot>结业证书未填写</option>
        <option value=GraduationCertificateSave>结业证书已保存</option>
        <option value=GraduationCertificateSubmit>结业证书审批中</option>
        <option value=GraduationCertificateReject>结业证书被驳回</option>
        <option value=RewardSituationNot>奖励登记未填写</option>
        <option value=RewardSituationSubmit>奖励登记已发放</option>
    </select>

    
    @*<div id="example" style="margin-left:-339px;margin-top:-6px">
        <div class="demo-section" style="width:470px">*@
   <input type="submit" value="查询" onclick="searchrightdataoffundslist()" style="width: 55px; height: 28px" />

    <script>
        $(document).ready(function () {
            function startChange() {
                var startDate = start.value(),
                endDate = end.value();

                if (startDate) {
                    startDate = new Date(startDate);
                    startDate.setDate(startDate.getDate());
                    end.min(startDate);
                } else if (endDate) {
                    start.max(new Date(endDate));
                } else {
                    endDate = new Date();
                    start.max(endDate);
                    end.min(endDate);
                }
            }

            function endChange() {
                var endDate = end.value(),
                startDate = start.value();

                if (endDate) {
                    endDate = new Date(endDate);
                    endDate.setDate(endDate.getDate());
                    start.max(endDate);
                } else if (startDate) {
                    end.min(new Date(startDate));
                } else {
                    endDate = new Date();
                    start.max(endDate);
                    end.min(endDate);
                }
            }

            var start = $("#startTime").kendoDatePicker({
                change: startChange
            }).data("kendoDatePicker");

            var end = $("#endTime").kendoDatePicker({
                change: endChange
            }).data("kendoDatePicker");
            $("#startTime").attr("readonly", true);
            $("#endTime").attr("readonly", true);
            start.max(end.value());
            end.min(start.value());
        });
    </script>
    <style scoped>
        #example .k-datepicker {
            vertical-align: middle;
        }

        #example h3 {
            clear: both;
        }

        #example .code-sample {
            width: 60%;
            float: left;
            margin-bottom: 20px;
        }

        #example .output {
            width: 24%;
            margin-left: 4%;
            float: left;
        }
    </style>
</div>
<br />
<div id="processwindow">
</div>
<script type="text/javascript">

    function OpenProcessWindow(id) {
        //  layer.load('加载带文字', 3);
        // layer.load(3);
        $("#processwindow").kendoWindow({
            position: {
                top: "12%", // or "100px"
                left: "8%"
            },
            width: "90%",
            height: "80%",
            modal: true,
            draggable: true,
            //title: "申请书",
            visible: false,
            actions: [
                    "Pin",
                    "Close",
                   // "Minimize",
                 // "Maximize"
            ],
            resizable: false,
            close: function (e) {
                parent.location.reload();//刷新页面
            }
        });

        $.ajax({
            url: "/Education/GraduateStudent/ReturnStateValue?id=" + id,
            type: "post",
            success: function (data) {
                if (data != null) {
                    // $("#MaxWindow").html(data);

                    var k = data;
                    //判断返回的状态来控制弹出框第一个打开的页面
                    if (data == "BookCostRegistNot") {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/BookCostRegistList?id=' + id + '">书本费使用登记</iframe>');
                    }
                    else if (data == "BookCostRegistSubmit" ||data=="GraduationCertificateNot") {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/GraduationCertificate?id=' + id + '">结业证书</iframe>');
                    }
                    else if (data == "GraduationCertificateSave") {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/GraduationCertificate?id=' + id + '">结业证书</iframe>');
                    }
                    else if (data == "GraduationCertificateSubmit" || data == "GraduationCertificateAgree") {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/GraduationCertificateAgree?id=' + id + '">结业证书审批中</iframe>');
                    }
                    else if (data == "GraduationCertificateReject") {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/GraduationCertificateReject?id=' + id + '">结业证书被驳回</iframe>');
                    }
                    else if (data == "RewardSituationNot" ) {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/RewardSituation?id=' + id + '">奖励登记</iframe>');
                    }
                    else if (data == "RewardSituationSubmit") {
                        $("#processwindow").append(' <iframe id="application" width="100%" height="160%" scrolling="no" style="border:0px" src="/Education/GraduateStudent/RewardSituation?id=' + id + '">奖励登记</iframe>');
                    }
                }
                else {
                    alert("发生异常！");
                }
            }
        });
        $("#processwindow").data("kendoWindow").center().open();
    }
</script>


<div id="bigfundsgrid" class="k-content">
    <div id="fundsGrid">

    </div>
    <script>
        $(function () {
            searchrightdataoffundslist();
        });

        function searchrightdataoffundslist() {
            var searchitem2 = $("#projectName").val();
            var searchitem3 = $("#State").val();
            var searchitem4 = $("#Freeze").val();
            var searchitem5 = $("#startTime").val();
            var searchitem6 = $("#endTime").val();
            var dataSource = new kendo.data.DataSource({
                transport: {
                    read: {
                        type: "post",
                        url: "/Education/GraduateStudent/ProcessingListStatistics?projectName=" +
                        encodeURI(searchitem2) + "&State=" + encodeURI(searchitem3) + "&Freeze=" +
                        encodeURI(searchitem4) + "&startTime=" + encodeURI(searchitem5) + "&endTime=" +
                        encodeURI(searchitem6) + "",
                        dataType: "json",
                        contentType: "application/json",
                    },

                    destroy: {
                        type: "post",
                        url: "/Education/GraduateStudent/DeleteProcessingListByModelId",
                        dataType: "json",
                        complete: function (e) {
                            $("#fundsGrid").data("kendoGrid").dataSource.read();
                        }
                    },
                    parameterMap: function (options, operation) {
                        if (operation == "read") {
                            var parameter = {
                                page: options.page,
                                pageSize: options.pageSize
                            };
                            return kendo.stringify(parameter);
                        }
                        if (operation == "destroy") {
                            options.action = operation;
                            return { modelId: kendo.stringify(options.models[options.models.length - 1].ID) };
                        }
                    },
                },

                batch: true,
                pageSize: 10,
                schema: {
                    model: {
                        //删除时必须有
                        id: "ID"
                    },
                    data: function (d) {
                        for (var i = 0; i < d.data.length; i++) {
                            ////将json时间转换
                            var birthdayMilliseconds = eval('new ' + d.data[i].ProjectEstablishTime.replace('/', '', 'g').replace('/', '', 'g'));
                            var birthday = birthdayMilliseconds.toLocaleDateString() + " " + birthdayMilliseconds.toLocaleTimeString();
                            d.data[i].TimeStr = birthday;
                            d.data[i].Department = d.data[i].FormValues.split('#')[20];
                            d.data[i].StudentType = d.data[i].FormValues.split('#')[4];
                            d.data[i].Applications = d.data[i].ApplicationStatus;
                            if (d.data[i].Applications == "CostRegistSubmit") {
                                d.data[i].Applications = "费用已登记";
                            }
                            else if (d.data[i].Applications == "BookCostRegistNot") {
                                d.data[i].Applications = "书本使用费未登记";
                            }
                            else if (d.data[i].Applications == "BookCostRegistSubmit") {
                                d.data[i].Applications = "书本使用费已登记";
                            }
                            else if (d.data[i].Applications == "GraduationCertificateNot") {
                                d.data[i].Applications = "结业证书未填写";
                            }
                            else if (d.data[i].Applications == "GraduationCertificateSave") {
                                d.data[i].Applications = "结业证书已保存";
                            }
                            else if (d.data[i].Applications == "GraduationCertificateSubmit") {
                                d.data[i].Applications = "结业证书审批中";
                            }
                            else if (d.data[i].Applications == "GraduationCertificateAgree") {
                                d.data[i].Applications = "结业证书审批中";
                            }
                            else if (d.data[i].Applications == "GraduationCertificateReject") {
                                d.data[i].Applications = "结业证书被驳回";
                            }
                            else if (d.data[i].Applications == "RewardSituationNot") {
                                d.data[i].Applications = "奖励登记未填写";
                            }
                            else if (d.data[i].Applications == "RewardSituationSubmit") {
                                d.data[i].Applications = "奖励登记已发放";
                            }
                            else {
                                d.data[i].Applications = "";
                            }

                        }
                        return d.data;

                    },
                    total: function (d) {
                        return d.total;
                    }
                },
                serverPaging: true,
            });

            $("#fundsGrid").kendoGrid({
                dataSource: dataSource,
                pageable: {
                    refresh: true,
                    pageSizes: true,
                    buttonCount: 5,
                    messages: {
                        display: "显示{0}-{1}条，共{2}条",
                        empty: "没有数据",
                        page: "页",
                        of: "/ {0}",
                        itemsPerPage: "条/页",
                        first: "第一页",
                        previous: "前一页",
                        next: "下一页",
                        last: "最后一页",
                        refresh: "刷新"
                    }
                },
                columns: [
              {
                  field: "ID",
                  //template: "<input type='checkbox' id='#: ID #' />",
                  title: "序号",
                  hidden: true,
              },
               {
                   field: "UserName",
                   title: "申请人",
                   width: "20%"
               },
                {
                    field: "Department",
                    title: "部门",
                    width: "20%"
                },
                {
                    field: "StudentType",
                    title: "研究生类型",
                    width: "30%"
                },
              {
                  field: "Applications",
                  title: "状态",
                  width: "25%"
              },
              {
                  field: "TimeStr",
                  title: "创建时间",
                  width: "25%"
              },
              {
                  command:
                  [{ name: "destroy", text: "删除", width: "10%" }]
              }
                ],
                editable: {
                    //mode: "inline",
                    mode: "popup"
                },
                selectable: true,
                change: onChange,
            });
        };
        function onChange(arg) {
            var selected = $.map(this.select(), function (item) {
                OpenProcessWindow(item.cells[0].outerText);
            });
        }
    </script>


</div>

